<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="참 잘했어요! 잘했도요.">
    <meta name="keywords" content="도전,챌린지,도전모임,결심,목표,동기부여,노력,새해목표,올해목표,새해맞이">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/confetti.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <link href="https://hangeul.pstatic.net/hangeul_static/css/NanumHarABeoJiEuiNaNum.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="chalSetup.css">

    <title>챌린지 개설하기</title>
    <link rel="icon" href="../icon/favicon.ico">
</head>

<body>
<section class="view">
    <div id="header"></div>
    <div class="contents-wrap">

        <div class="chalSetupTutorial page active" id="chalSetupTutorial">
            <h3>챌린지를 여는 이 순간부터,<br>당신은 챌린지를 이끌어나갈<br>'리더'가 됩니다. 😄</h3>
            <h5>그 전에 3가지만 약속해 주세요!</h5>
            <div class="checkBox_wrap">
                <input type="checkbox" id="ckBox1">
                <label for="ckBox1">모두에게 기분 좋은 챌린지가 되도록 노력해주실거죠?</label>
            </div>
            <div class="checkBox_wrap">
                <input type="checkbox" id="ckBox2">
                <label for="ckBox2">참가자들의 의지와 예치금이 모일 챌린지입니다.<br>
                    책임감 있게 관리해주실거죠?</label>
            </div>
            <div class="checkBox_wrap">
                <input type="checkbox" id="ckBox3">
                <label for="ckBox3">유저가 개설한 챌린지의 인증샷은 잘했도요에서<br>
                    관여하지 않습니다. 챌린지를 개설한 리더가 책임감을<br>
                    가지고 공정하게 검토해 주세요!</label>
            </div>
            <button id="submitButton" onclick="showPage('chalsetup')" disabled>네, 약속할게요.</button>
        </div>

        <div class="chalsetup page" id="chalsetup">
            <div class="setup-cate">
                <h3>카테고리 선택 <span>*</span></h3>
                <div class="cate-scroll">
                    <input type="radio" name="setup-cate" id="cate1"><label for="cate1">운동</label>
                    <input type="radio" name="setup-cate" id="cate2"><label for="cate2">식습관</label>
                    <input type="radio" name="setup-cate" id="cate3"><label for="cate3">생활</label>
                    <input type="radio" name="setup-cate" id="cate4"><label for="cate4">정서</label>
                    <input type="radio" name="setup-cate" id="cate5"><label for="cate5">취미</label>
                    <input type="radio" name="setup-cate" id="cate6"><label for="cate6">환경</label>
                </div>
            </div>

            <div class="setup-title">
                <h3 style="margin:7px 0px;">챌린지 제목 <span>*</span></h3>
                <input type="radio" id="chal-public" name="chal-class" checked="checked">
                <label for="chal-public">공개 챌린지&nbsp;</label>
                <input type="radio" id="chal-private" name="chal-class">
                <label for="chal-private">비공개 챌린지</label>
                <br>
                <input type="text" placeholder="챌린지 명을 입력하세요." maxlength="20"
                       oninput="handleInput(this, 'chaltitleCount')"
                       required>
                <p><span id="chaltitleCount">0</span>/20</p>
            </div>

            <div class="private-code" id="private-code" style="display: none;">
                <h3>참여 코드 <span>*</span></h3>
                <h5>숫자와 문자 모두 입력할 수 있습니다.</h5>
                <input type="text" maxlength="10" placeholder="냥냥펀치, 1234"
                       oninput="handleInput(this, 'privatecodecount')">
                <p><span id="privatecodecount">0</span>/10</p>
            </div>

            <div class="setup-photo">
                <div>
                    <h3>대표 사진</h3>
                    <h6>썸네일은 내 챌린지의 얼굴!<br>
                        챌린지를 설명할 수 있는 이미지를 업로드해 주세요.</h6>
                    <p>(확장자: jpg, png /1:1 비율 권장)</p>
                </div>
                <div class="Thumbnail-photo">
                    <div id="thumbnail_container1"></div>
                    <label for="photoupload1">📸 사진 업로드</label>
                    <input type="file" id="photoupload1" accept="image/*" class="photoupload"
                           onchange="setThumbnail('photoupload1');" style="display: none;">
                </div>
            </div>

            <div class="setup-weeks">
                <h3>챌린지 기간 <span>*</span></h3>
                <input type="text" class="flatpickr" id="flatpickr3" placeholder="클릭하여 기간 설정">
                <div>
                    간편 선택:
                    <input type="radio" id="everyday" name="chalday">
                    <label for="everyday">매일&nbsp;</label>
                    <input type="radio" id="weekday" name="chalday">
                    <label for="weekday">평일&nbsp;</label>
                    <input type="radio" id="weekend" name="chalday">
                    <label for="weekend">주말</label>
                    <br>
                </div>
                직접 선택:
                <input type="checkbox" class="weekd" id="mon">
                <label for="mon">월</label>
                <input type="checkbox" class="weekd" id="tue">
                <label for="tue">화</label>
                <input type="checkbox" class="weekd" id="wed">
                <label for="wed">수</label>
                <input type="checkbox" class="weekd" id="thu">
                <label for="thu">목</label>
                <input type="checkbox" class="weekd" id="fri">
                <label for="fri">금</label>
                <input type="checkbox" class="weeke" id="sat">
                <label for="sat">토</label>
                <input type="checkbox" class="weeke" id="sun">
                <label for="sun">일</label>
            </div>

            <div class="setup-confirm">
                <label for="approval-message">
                    <h3>인증 방법 <span>*</span></h3>
                </label>
                <textarea id="approval-message" name="approval-message" rows="6" maxlength="100"
                          placeholder="예시) 만보기를 찍어서 업로드해 주세요, 오늘 하루 배운 내용을 간략하게 정리해 주세요."
                          oninput="handleInput(this, 'approvalcount')" required></textarea>
                <p><span id="approvalcount">0</span>/100</p>
                <h3>인증샷 예시 <span>*</span></h3>
                <div class="approval-flex">
                    <div class="approval-photo">
                        <div id="thumbnail_container2"></div>
                        <label for="photoupload2">⭕이렇게 인증해 주세요!</label>
                        <input type="file" id="photoupload2" accept="image/*" class="photoupload"
                               onchange="setThumbnail('photoupload2');" style="display: none;">
                    </div>
                    <div class="approval-photo">
                        <div id="thumbnail_container3"></div>
                        <label for="photoupload3">❌이렇게 찍으면 안돼요!</label>
                        <input type="file" id="photoupload3" accept="image/*" class="photoupload"
                               onchange="setThumbnail('photoupload3');" style="display: none;">
                    </div>
                </div>
            </div>


            <div class="setup-bank">
                <h3>예치금 <span>*</span>
                    <input type="checkbox" id="bankfixed">
                    <label for="bankfixed" style="font-size:16px">고정 예치금</label>
                </h3>
                <div id="bankblock">
                    <p>최소 1만원 ~ 최대 20만원까지 설정할 수 있어요.</p>
                    <input type="text" id="moneyset" maxlength="8">
                </div>
                <div style="display: none;" id="fixedblock">
                    <p>최소 1,000원부터 설정할 수 있어요.</p>
                    <input type="text" id="moneyfixed" maxlength="8">
                </div>
            </div>


            <div class="setup-people-limit">
                <div class="setup-people">
                    <h3 style="margin:0px; padding:0px;">최대 참가 인원 제한하기</h3>
                    <label class="toggleSwitch" id="people-limit">
                        <span class="toggleButton"></span>
                    </label>
                </div>
                <input type="text" id="limit-form" maxlength="4" style="display: none; margin-top:10px;"
                       placeholder="최소 2명부터 최대 1,000명부터 설정할 수 있어요.">
            </div>


            <div class="keyword-input">
                <div class="setup-keyword">
                    <div class="keyword-toggle">
                        <h3>검색 키워드 입력&nbsp;<span style="color:#bbb; font-size:18px;">최대 3개</span></h3>
                        <label class="toggleSwitch" id="chal-keyword">
                            <span class="toggleButton"></span>
                        </label>
                    </div>
                    <h5>내 챌린지를 표현하는 단어를 추가해 보세요!<br>
                        (검색 키워드로 활용됩니다.)</h5>
                    <input type="text" id="keyword-form" style="display: none;"
                           placeholder="스페이스바로 구분하며 특수문자 사용이 불가합니다.">
                </div>
            </div>

            <div class="setup-agree">
                <input type="checkbox" id="chalagree">
                <label for="chalagree">챌린지 개설 약관에 동의합니다.</label>
            </div>

            <div class="setupsubmit">
                <button id="setupsubmit" disabled>개설하기</button>
            </div>

        </div>

    </div>
</section>

<script>

    //헤더 로딩
    $(function () {
        $("#header").load("header.html");
    });

    //////////////////////////flatpickr 캘린더 라이브러리 /////////////////////////////////
    document.addEventListener('DOMContentLoaded', function () {
        let flatpickr3 = flatpickr("#flatpickr3", {
            locale: 'ko',
            mode: 'range',
            locale: 'ko',
            dateFormat: 'Y-m-d',
            minDate: 'today',
            maxDate: new Date().fp_incr(365),
            altInput: true,
            altFormat: 'Y년 F j일'
        });
    });

    //////////////////////////////////체크박스 유효성 처리//////////////////////////////////

    //챌린지 개설 전 약속 부분 체크박스 상태 감지
    $(document).ready(function () {
        function updateButtonState() {
            $('#submitButton').prop('disabled',
                !($('#ckBox1').is(':checked') && $('#ckBox2').is(':checked') && $('#ckBox3').is(':checked'))
            );
        }

        $('#ckBox1, #ckBox2, #ckBox3').change(updateButtonState);
        updateButtonState();

        window.showPage = function (pageId) {
            $(".active").removeClass("active");
            $("#" + pageId).addClass("active");
        };
    });


    //개설하기 약관동의 체크박스 상태 감지
    document.addEventListener('DOMContentLoaded', function () {
        const chalagree = document.getElementById('chalagree');
        const setupsubmit = document.getElementById('setupsubmit');

        chalagree.addEventListener('change', function () {
            setupsubmit.disabled = !this.checked;
        });
    });

    //챌린지 요일 선택 부분 라디오 선택값에 따른 체크박스 상태 변경
    document.addEventListener('DOMContentLoaded', function () {
        const everyday = document.querySelector('#everyday');
        const weekday = document.querySelector('#weekday');
        const weekend = document.querySelector('#weekend');
        const weekdCheckboxes = document.querySelectorAll('.weekd');
        const weekeCheckboxes = document.querySelectorAll('.weeke');

        // 체크박스 상태를 업데이트하는 함수
        function updateCheckboxes(weekdChecked, weekeChecked) {
            for (const checkbox of weekdCheckboxes) {
                checkbox.checked = weekdChecked;
            }
            for (const checkbox of weekeCheckboxes) {
                checkbox.checked = weekeChecked;
            }
        }

        // 라디오 버튼 변경 이벤트 리스너
        everyday.addEventListener('click', function () {
            updateCheckboxes(everyday.checked, everyday.checked);
            weekday.checked = weekend.checked = false;
        });

        weekday.addEventListener('click', function () {
            updateCheckboxes(weekday.checked, false);
            everyday.checked = weekend.checked = false;
        });

        weekend.addEventListener('click', function () {
            updateCheckboxes(false, weekend.checked);
            everyday.checked = weekday.checked = false;
        });
    });


    ///////////////////////////////////////글자 수 제한 처리 관련 로직////////////////////////////////////////

    //순수 글자 개수 제한에 대한 처리
    function handleInput(inputElement, charCountId) {
        let inputText = inputElement.value;
        let charCount = 0;

        for (let char of inputText) {
            charCount += /[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F]/.test(char) ? 1 : char.length;
        }

        const maxLength = parseInt(inputElement.getAttribute('maxlength'), 10);
        if (charCount > maxLength) {
            inputElement.value = inputText.substring(0, inputText.length - 1);
            charCount = maxLength;
        }
        // 숫자 타입인 charCount를 문자열로 변환
        document.getElementById(charCountId).textContent = charCount.toString();
    }


    //예치금, 최대 인원 숫자 제한 적용
    $(document).ready(function () {
        // , 처리 적용
        $('#limit-form, #moneyset, #moneyfixed').mask('#,##0', {reverse: true});

        // 숫자 유효성 처리를 위한 정규 표현식
        const replaceNotInt = /[^0-9]/g;

        // 최대 참가 인원 제한에 대한 유효성 처리
        $("#limit-form").on("input", function () {
            let inputValue = $(this).val().replace(replaceNotInt, "");
            let numValue = parseInt(inputValue, 10);
            numValue = isNaN(numValue) ? 2 : Math.min(1000, Math.max(2, numValue));
            $(this).val(numValue);
        });

        // 예치금 부분에 대한 유효성 처리
        $("#moneyset, #moneyfixed").on("input", function () {
            let inputValue = $(this).val().replace(replaceNotInt, "");
            let numValue = parseInt(inputValue, 10);
            numValue = isNaN(numValue) ? 0 : Math.min(200000, Math.max(0, numValue));
            $(this).val(numValue);
        });
    });


    //키워드 입력 부분 제한 처리
    $(document).ready(function () {
        // 특수문자 정규식 변수(공백 미포함)
        let replaceChar = /[~!@\#$%^&*\()\-=+_'\;<>0-9\/.\`:\"\\,\[\]?|{}]/gi;
        // 자음, 모음 한글 정규식
        let replaceNotFullKorean = /[ㄱ-ㅎㅏ-ㅣ]/gi;

        // 입력 폼에서 focusout 이벤트 발생 시 유효성 검사
        $("#keyword-form").on("focusout", function () {
            let x = $(this).val();
            if (x.length > 0) {
                if (x.match(replaceChar) || x.match(replaceNotFullKorean)) {
                    x = x.replace(replaceChar, "").replace(replaceNotFullKorean, "");
                }
                $(this).val(x);
            }
        }).on("keyup", function () {
            // 키 입력 시 특수문자 바로 제거
            $(this).val($(this).val().replace(replaceChar, ""));
        });
    });

    ///////////////////////////////토글이나 체크박스 선택에 따른 인풋 창 전환 /////////////////////////////////////

    // 챌린지 공개여부에 따라 비밀번호 입력 창 추가
    document.querySelector('#chal-private').addEventListener('click', () => {
        document.querySelector('#private-code').style.display = 'inline-block';
    });

    document.querySelector('#chal-public').addEventListener('click', () => {
        document.querySelector('#private-code').style.display = 'none';
    });


    // 토글 버튼 온오프 처리
    const toggleList = document.querySelectorAll(".toggleSwitch");

    toggleList.forEach(($toggle) => {
        $toggle.addEventListener('click', () => {
            $toggle.classList.toggle('active');
        });
    });


    // 예치금 변경 체크 여부에 따른 화면 전환
    document.getElementById('bankfixed').addEventListener('change', function () {
        const bankBlock = document.getElementById('bankblock');
        const fixedBlock = document.getElementById('fixedblock');

        if (this.checked) {
            bankBlock.style.display = 'none';
            fixedBlock.style.display = 'inline-block';
        } else {
            bankBlock.style.display = 'inline-block';
            fixedBlock.style.display = 'none';
        }
    });


    //최대 인원 토글에 따른 화면 전환
    document.addEventListener('DOMContentLoaded', function () {
        const peopleLimitButton = document.getElementById('people-limit');
        const peopleLimitForm = document.getElementById('limit-form');

        peopleLimitButton.addEventListener('click', function () {
            if (peopleLimitForm.style.display === 'none') {
                peopleLimitForm.style.display = 'block';
            } else {
                peopleLimitForm.style.display = 'none';
            }
        });


        // 검색 키워드 버튼과 폼
        let keywordButton = document.getElementById('chal-keyword');
        let keywordForm = document.getElementById('keyword-form');

        // 버튼 클릭 이벤트 리스너로 화면 토글 기능 구현
        keywordButton.addEventListener('click', function () {
            keywordForm.style.display = (keywordForm.style.display === 'none') ? 'block' : 'none';
        });
    });


    //////////////////////////////이미지 업로드 및 미리보기 생성/////////////////////////////////
    function setThumbnail(inputId) {
        const imageContainer = document.querySelector(`#thumbnail_container${inputId.substr(-1)}`);
        imageContainer.innerHTML = '';

        const file = document.querySelector(`#${inputId}`).files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.src = event.target.result;
                imageContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    }

</script>
</body>

</html>